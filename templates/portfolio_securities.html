<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Securities</title>

    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/portfolio_securities.css">
</head>
<body>

<nav class="navbar">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/portfolio_securities" class="active">Portfolio Securities</a></li>
  </ul>
</nav>

<div class="content">
  <div class="panel">

    <h3>Portfolio Securities</h3>

    <!-- ================== FORM ================== -->
    <form action="/portfolio_securities/load" method="POST" id="pfForm" class="pf-form">

      <label for="portfolioSelect" class="pf-label">Select Portfolio:</label>

      <select id="portfolioSelect" name="portfolio_id" required class="pf-select">
        {% for p in portfolios %}
          <option value="{{ p.id }}" {% if selected_portfolio == p.id %}selected{% endif %}>
              {{ p.portfolio_code }} - {{ p.name }}
          </option>
        {% endfor %}
      </select>

      <input type="hidden" name="page" id="pageInput" value="{{ page_data.page if page_data else 1 }}">
      <input type="hidden" name="page_size" value="20">

      <button type="submit" class="green-btn" onclick="showLoader(this)">Load</button>
    </form>


    <!-- ================== ACTIONS ================== -->
    {% if selected_portfolio %}
    <div class="actions-row">

        <a class="csv-icon-btn"
           href="/portfolio_securities/export_csv?portfolio_id={{ selected_portfolio }}"
           title="Download CSV">
           ⬇
        </a>

        <button type="button" class="green-btn" onclick="openAddModal()">+ Add Securities</button>


    </div>
    {% endif %}


    <!-- ================== TABLE ================== -->
    {% if page_data %}
      <table class="styled-table" id="pfTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ticker</th>
            <th>Name</th>
            <th>CIK</th>
            <th>Added</th>
            <th>Active</th>
            <th>Weight</th>
          </tr>
        </thead>
        <tbody>
          {% for s in page_data.items %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.ticker }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.cik }}</td>
            <td>{{ s.added_at }}</td>
            <td>{{ s.is_active }}</td>
            <td>{{ s.weight }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- ================== PAGINATION ================== -->
      <div class="pagination">
        <button type="button"
                onclick="goPage({{ page_data.page - 1 }})"
                {% if page_data.page <= 1 %}disabled{% endif %}>
          ◀ Prev
        </button>

        <span>
            Page {{ page_data.page }} /
            {{
                (page_data.total_count // page_data.page_size)
                + (1 if page_data.total_count % page_data.page_size > 0 else 0)
            }}
        </span>

        <button type="button"
                onclick="goPage({{ page_data.page + 1 }})"
                {% if page_data.page * page_data.page_size >= page_data.total_count %}disabled{% endif %}>
          Next ▶
        </button>
      </div>
    {% endif %}

  </div>
</div>

<script src="/static/js/portfolio_securities.js"></script>

<!-- ========== ADD SECURITIES MODAL ========== -->
<div id="addModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">

      <div class="modal-header">
          <h3>Add Securities</h3>
          <button class="modal-close" onclick="closeAddModal()">✖</button>
      </div>

      <div class="modal-content">

          <!-- Tabs -->
          <div class="modal-tabs">
              <button class="tab-btn active" onclick="showTab('singleTab', event)">Search & Add</button>
              <button class="tab-btn" onclick="showTab('csvTab', event)">CSV Import</button>

          </div>

          <!-- TAB 1: Single Search -->
          <div id="singleTab" class="tab-content active">
              <label>Search Security:</label>
              <input type="text" id="searchInput" placeholder="Ticker or Name..." oninput="searchSecurities()">

              <div id="searchResults" class="search-results"></div>
          </div>

          <!-- TAB 2: CSV Import -->
          <div id="csvTab" class="tab-content">
              <label>Paste CSV:</label>
              <textarea id="csvInput" placeholder="TICKER,WEIGHT"></textarea>

              <button class="import-btn" onclick="importCSV(this)">Import CSV</button>

              <div id="csvResult" class="csv-result"></div>
          </div>

      </div>

  </div>
</div>

</body>
</html>
